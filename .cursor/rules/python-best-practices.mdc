---
description:
globs:
alwaysApply: true
---
# Python Best Practices for Intervals MCP Server

## Code Style and Readability

- Follow **PEP 8** for formatting, indentation, and naming conventions
- Write readable, maintainable code:
  - Use descriptive names for variables, functions, and classes
  - Keep functions short and single-purpose (see MCP tools in [server.py](mdc:src/intervals_mcp_server/server.py))
  - Keep indentation and spacing consistent
- Embrace Pythonic idioms:
  - Use list/dict comprehensions and generators where appropriate
  - Prefer built-in functions and stdlib modules
  - Use context managers (like the `lifespan` manager for httpx client)
- Avoid global variables except for validated constants (API_KEY, ATHLETE_ID)
- Use lazy **`%`** formatting in logging calls: `logger.debug("val=%s", val)`
- Represent datetimes as timezone-aware UTC objects when possible

## Type Annotations and Documentation

- Add **type hints** to all function signatures (see examples in [server.py](mdc:src/intervals_mcp_server/server.py))
- Use built-in collection types (`list`, `dict`, `set`, `tuple`) instead of `typing.List`, etc.
- Provide clear **docstrings** for:
  - All MCP tool functions (required by FastMCP)
  - Public utility functions in [utils/formatting.py](mdc:src/intervals_mcp_server/utils/formatting.py)
  - The main module docstring explaining the server's purpose
- Use inline comments only for non-obvious logic

## Error Handling and Validation

- Handle errors gracefully with explicit `try/except` blocks (see `make_intervals_request()`)
- Catch specific exceptions: `httpx.HTTPStatusError`, `httpx.RequestError`, etc.
- Return consistent error structures with user-friendly messages
- Validate inputs:
  - Check API key and athlete ID on startup
  - Validate date formats in MCP tools
  - Use regex pattern `r"i?\d+"` for athlete ID validation

## Async Programming Patterns

- Use `async/await` consistently for all MCP tools and API calls
- Share a single `httpx.AsyncClient` instance across requests
- Properly close async resources using lifespan context manager
- Follow FastMCP's async patterns for tool implementations

## Testing Standards

- Write unit tests for all MCP tools and utilities
- Use **pytest** with `pytest-asyncio` for async function testing
- Use **pytest-mock** (`MockerFixture`) for mocking HTTP requests
- Test both success and error paths
- Mock external API calls to avoid dependencies in tests

## Development Environment

- Target **Python 3.12+** as specified in [pyproject.toml](mdc:pyproject.toml)
- Use **uv** for package management: `uv sync --all-extras`
- Manage dependencies in `pyproject.toml` with lock file (`uv.lock`)
- Always use virtual environments (`.venv/`)
- Run quality checks before commits:
  - `ruff .` for linting
  - `mypy src tests` for type checking
  - `pytest` for tests

## Security Practices

- Never hard-code secrets - use environment variables via `.env` file
- Load sensitive data (API_KEY, ATHLETE_ID) from environment
- Use HTTP Basic Auth for API authentication
- Validate all external inputs before processing
- Follow least-privilege principles for API access

## Project-Specific Patterns

- All API communication through `make_intervals_request()` function in [api/client.py](mdc:src/intervals_mcp_server/api/client.py)
- Consistent error response format: `{"error": True, "status_code": int, "message": str}`
- Use formatting utilities from [utils/formatting.py](mdc:src/intervals_mcp_server/utils/formatting.py)
- Use validation utilities from [utils/validation.py](mdc:src/intervals_mcp_server/utils/validation.py)
- Follow MCP tool naming conventions: `get_*` for retrieval operations
- Support both numeric and i-prefixed athlete IDs (validated with `resolve_athlete_id()`)

## Code Organization

- **Modular Structure**: Organize MCP tools by domain in [tools/](mdc:src/intervals_mcp_server/tools/) directory:
  - `activities.py` - Activity-related tools
  - `events.py` - Event management tools
  - `wellness.py` - Wellness data tools
  - `plans.py` - Training plan tools
  - `performance.py` - Athlete performance data tools
- **Registration**: Import all tools in [tools/__init__.py](mdc:src/intervals_mcp_server/tools/__init__.py) and add to `__all__`
- **API Layer**: HTTP client and request handling in [api/client.py](mdc:src/intervals_mcp_server/api/client.py)
- **Utilities**: Place formatting, validation, and helper functions in [utils/](mdc:src/intervals_mcp_server/utils/)
- **Testing**: Organize tests by functionality in [tests/](mdc:tests) directory
- **Package Markers**: Use `__init__.py` files to mark Python packages
- **Type Support**: Include `py.typed` for type checking support

## MCP Tool Development Pattern

When creating new tools:
1. Choose or create appropriate module in `tools/`
2. Import shared `mcp` instance: `from intervals_mcp_server.mcp_instance import mcp`
3. Use `@mcp.tool()` decorator for tool registration
4. Import utilities as needed (`make_intervals_request`, `resolve_athlete_id`, etc.)
5. Register in `tools/__init__.py` for re-export
